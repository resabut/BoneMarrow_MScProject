---
title: "Cell frequency analysis"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# load
```{r load libraries}
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(patchwork)
library(dittoSeq)
library(speckle)
library(limma)
setwd("/home/inf-38-2022/MScProject/02_CellFrequency/")
source("../b00_SexAssignment/b00_SexAssignment.R")
```
load data
```{r load data}
# setwd("/home/inf-38-2022/MScProject/02_CellFrequency/")
rna.data <- readRDS("../01_Integration/rna_annotated_immature.rds")
```

Add sex annotation
```{r}
sex_assign_out <- SexAssign(data = rna.data, sex_col = "gender", sample_col = "sample", report = TRUE,
                            assay = "raw"
)
# if "RNA" is not working, try "raw"
# see table
sex_assign_out[[2]]
# see plot
sex_assign_out[[3]]
```
Now we change the seurat object
```{r}

# add to object
rna.data <- sex_assign_out[[1]]
# save rds
saveRDS(rna.data,"../01_Integration/immature_sex_annotated.rds", compress=FALSE)
# ignore inconclusive sex
rna.data <- subset(rna.data, subset = Predicted_sex != "inconclusive")
```
We add simplified cell types
```{r}
b_cells <- c("Naive B cell", "Memory B cell", "Plasma cell", "preB cell", "preB cell (cycling)", "proB cell", "proB cell (cycling)", "Plasma cell")
t_nk_cells <- c("Naive CD8 T cell", "Effector/Memory CD4 T cell", "Naive CD4 T cell",
                "GZMK+ CD8 T cell", "Gamma-delta T cell", "IFN-activated T cell", "Treg", "GZMB+ CD8 T cell", "MAIT", "T/NK cell (cycling)", "CD16+ NK", "Tissue-resident NK cell", "CD56+ NK", "ILC")
erythrocytes <- c("Early SOX4+ erythroblast", "Late hemoglobin+ erythroblast", "Fetal HBG+ erythrocyte",
                  "Intermediate EPCAM+ erythroblast", "Erythrocyte")
monocytes <- c("CD14+MHCIIhigh monocyte", "CD14+MHCIIlow monocyte", "Macrophage", "CD16+ monocyte")
granulocyte <- c("S100A+ preNeutrophil (cycling)", "S100A+ preNeutrophil", "Metamyelocyte/Band neutrophil",
                 "Neutrophil", "Promyelocyte", "Myelocyte", "Mast cell")
dendritic_cells <- c("pre-pDC (lymphoid origin)", "pre-pDC (myeloid origin)", "cDC2", "cDC2 (cycling)", "cDC1", "pDC")
Mk <- c("Megakaryocyte", "Megakaryocyte progenitor", "Platelet")

progenitor_cells <- c("CLP", "CMP", "GMP", "MEP", "MPP", "CDP", "HSC")

stroma <- c("Fibroblast", "Mesenchymal stromal cell", "Osteoclast")
```
# plot cell frequency plots
```{r plot cell frequency}
simplified_ct_list <- rna.data@meta.data %>% distinct(simplified_ct, ct)
simplified_ct_plot_list <- list()
Idents(rna.data) <- rna.data$simplified_ct
# plot with for loop
for (i in seq_along(simplified_ct_list$simplified_ct %>% unique())) {
  cell_type <- unique(simplified_ct_list$simplified_ct)[i]
  print(cell_type)
  ct_list <- simplified_ct_list %>%
    filter(simplified_ct == cell_type) %>%
    pull(ct)
  dittoFreqPlot(rna.data, "ct", sample.by = "sample", # not sample id
                group.by = "Predicted_sex", data.out = TRUE,
                vars.use = ct_list,

                main = paste0(cell_type, " frequency")) -> freq.data
  freq.data[[2]] %>%
    filter(label.count.total.per.facet > 10) %>% # remove facet points with less than 10 cells
    ggplot(aes(x = grouping, y = percent)) +
    geom_boxplot() +
    geom_point() +
    facet_wrap(~label, scales = "free") +
    labs(title = paste0(cell_type, " frequency under 45")) -> plot

  assign(paste0(gsub(" ", "_", cell_type), "_plot"), plot)
  simplified_ct_plot_list <- c(simplified_ct_plot_list, mget(paste0(gsub(" ", "_", cell_type), "_plot")))
}
# plot frequency of all cell types by sample faceted by report
rna.data %>%
  dittoBarPlot(var = "ct", group.by = "sample", split.by = "projectId",
               split.adjust = list(scales = "free"), # removes empty groups
               main = "Cell type by individual and project"
  ) -> ct_individual_plot
ct_individual_plot

dittoBarPlot(rna.data, var="ct", group.by="sample", scale = "count",
             split.by = "projectId", split.adjust = list(scales = "free")) -> progenitor_counts
progenitor_counts
```
This is for the lab meeting tips and tricks
```{r}
meta.data <- rna.data@meta.data
dittoBarPlot(rna.data, var="ct", group.by="sample",
             split.by = "Predicted_sex", split.adjust = list(scales = "free")) +
# change axis name
    labs(x = "Sample", y = "Cell count", title = "Cell type by sample and sex") +
    # change legend name
    scale_fill_discrete(name = "Cell types")
propeller(clusters = meta.data$ct, sample = meta.data$sample, group = meta.data$Predicted_sex) -> prop.out
prop.out
```
For specific plots:
```{r}
cell_type_list <- c("CLP", "MPP", "CMP", "GMP", "MEP", "CDP", "HSC")
ct_plot_list <- list()
for (i in seq_along(cell_type_list)) {
  cell_type <- cell_type_list[i]
  print(cell_type)
  dittoFreqPlot(rna.data, "ct", sample.by = "sample", # not sample id
              group.by = "Predicted_sex", data.out = TRUE, vars.use = cell_type,
                main = paste0(cell_type, " frequency")) -> freq.data
  freq.data[[2]] %>%
    filter(label.count.total.per.facet > 10) %>% # remove facet points with less than 10 cells
    ggplot(aes(x = grouping, y = percent, fill=grouping)) +
    geom_violin() +
    geom_point() +

    facet_wrap(~label, scales = "free") +
          # change name of x axis
          xlab("Sex") +
            # change name of y axis
            ylab("Frequency overall") +

          theme_bw() +
          # big text
            theme(text = element_text(size = 20)) +

    labs(title = paste(cell_type, "frequency")) -> plot
  assign(paste0(gsub(" ", "_", cell_type), "_plot"), plot)
  ct_plot_list <- c(ct_plot_list, mget(paste0(gsub(" ", "_", cell_type), "_plot")))
}
```

```{r}
pdf("individual_celltype_distribution_immature.pdf", width = 10, height = 10)
ct_individual_plot
simplified_ct_plot_list
ct_plot_list
dev.off()
ct_individual_plot
simplified_ct_plot_list
ct_plot_list
```

# speckle
```{r speckle}
rna.data@meta.data -> meta.data
# drop cells with inconclusive Predicted_sex
meta.data %>%
        filter(Predicted_sex != "inconclusive") -> meta.data
propeller(clusters = meta.data$ct, sample = meta.data$sample, group = meta.data$Predicted_sex) -> prop.out
prop.out
propeller(clusters = meta.data$ct, sample = meta.data$sample, group = meta.data$Predicted_sex,
          transform = "asin"
) -> propeller_asin.out
propeller_asin.out
```

to a more complex model:
```{r}
rna.data@meta.data -> meta.data
# drop cells with inconclusive Predicted_sex
meta.data %>%
        filter(Predicted_sex != "inconclusive") -> meta.data

# get proportion of cells in each cluster for each sample
props <- getTransformedProps(clusters = meta.data$ct, sample = meta.data$sample, transform="logit")
# wide format
props.info <- props$Proportion %>%
        as.data.frame() %>%
        pivot_wider(names_from = sample, values_from = Freq)
ct_rownames <- props.info$clusters
props.info <- select(props.info, -clusters)
rownames(props.info) <- ct_rownames

# get sample information
sample.info <- meta.data %>%
        distinct(sample, Predicted_sex, age, project_id)

# total number of cells
nrow(meta.data) -> ncells

design <- model.matrix(~ 0 + sample.info$Predicted_sex + sample.info$project_id)
colnames(design) <- c("Female", "Male", make.names(colnames(design))[3:ncol(design)])

```

now test
```{r}
mycontr <- makeContrasts(Male-Female, levels=design)
propeller.ttest(props, design, contrasts = mycontr,
                robust=TRUE, trend=FALSE, sort=TRUE) -> prop.ttest.out
prop.ttest.out
```

## continous variable
```{r}
rna.data@meta.data -> meta.data
# drop cells with inconclusive Predicted_sex
meta.data %>%
        filter(Predicted_sex != "inconclusive") %>%
        filter(!is.na(age)) -> meta.data

# get proportion of cells in each cluster for each sample
props <- getTransformedProps(clusters = meta.data$ct, sample = meta.data$sample, transform="logit")
# wide format
props.info <- props$Proportion %>%
        as.data.frame() %>%
        pivot_wider(names_from = sample, values_from = Freq)
ct_rownames <- props.info$clusters
props.info <- select(props.info, -clusters)
rownames(props.info) <- ct_rownames

# get sample information
sample.info <- meta.data %>%
        distinct(sample, Predicted_sex, age, project_id)

# total number of cells
nrow(meta.data) -> ncells


design <- model.matrix(~ 0 + sample.info$Predicted_sex + sample.info$age)
colnames(design) <- c("Female", "Male", "Age")

# for random  effect
dupcor <- duplicateCorrelation(props.info, design, block = sample.info$project_id)
```


now test
```{r}
fit <- lmFit(props.info, design,
             block = sample.info$project_id,
             correlation = dupcor$consensus)
fit <- eBayes(fit)
topTable(fit, number = 10 ) -> top.table
top.table
summary(decideTests(fit))
```
plot
## another vers
```{r}
rna.data@meta.data -> meta.data
# drop cells with inconclusive Predicted_sex
meta.data %>%
        filter(Predicted_sex != "inconclusive") %>%
        filter(!is.na(age)) -> meta.data

# get proportion of cells in each cluster for each sample
props <- getTransformedProps(clusters = meta.data$ct, sample = meta.data$sample, transform="logit")
# wide format
props.info <- props$Proportions %>%
        as.data.frame() %>%
        pivot_wider(names_from = sample, values_from = Freq)
ct_rownames <- props.info$clusters
props.info <- select(props.info, -clusters)
rownames(props.info) <- ct_rownames

# get sample information
sample.info <- meta.data %>%
        distinct(sample, Predicted_sex, age, project_id) %>%
        # code sex in binary, 0= Male, 1= Female
        mutate(sex_bin = ifelse(Predicted_sex == "F", 1, 0))

# total number of cells
nrow(meta.data) -> ncells

design <- model.matrix(~ 0 + sample.info$sex_bin + sample.info$age)
colnames(design) <- c("sex_bin", "age")
dupcor <- duplicateCorrelation(props.info, design, block = sample.info$project_id)

```

now test
```{r}
fit <- lmFit(props.info, design,
             block = sample.info$project_id,
             correlation = dupcor$consensus)
fit <- eBayes(fit)
topTable(fit, number = 10 ) -> top.table
top.table
summary(decideTests(fit))
```

# others
```{r}
# create lineages based on ct
lymphoid_lineage <- c("Naive B cell", "Memory B cell", "Plasma cell", "preB cell", "preB cell (cycling)", "proB cell", "proB cell (cycling)", "Plasma cell", "Naive CD8 T cell", "Effector/Memory CD4 T cell", "Naive CD4 T cell",
                "GZMK+ CD8 T cell", "Gamma-delta T cell", "IFN-activated T cell", "Treg", "GZMB+ CD8 T cell", "MAIT", "T/NK cell (cycling)", "CD16+ NK", "Tissue-resident NK cell", "CD56+ NK", "ILC", "CLP")
gmp_lineage <- c("GMP", "CD14+MHCIIhigh monocyte", "CD14+MHCIIlow monocyte", "Macrophage", "CD16+ monocyte", "S100A+ preNeutrophil (cycling)", "S100A+ preNeutrophil", "Metamyelocyte/Band neutrophil",
                 "Neutrophil", "Promyelocyte", "Myelocyte", "Mast cell")
dendritic_cell_lineage <- c("pre-pDC (myeloid origin)", "cDC2", "cDC2 (cycling)", "cDC1", "pDC", "CDP", "pre-pDC (lymphoid origin)" )
mep_lineage <- c("MEP", "Early SOX4+ erythroblast", "Late hemoglobin+ erythroblast", "Fetal HBG+ erythrocyte", "Intermediate EPCAM+ erythroblast", "Erythrocyte", "Megakaryocyte", "Megakaryocyte progenitor", "Platelet")
early_progenitor_cells <- c("CMP", "HSC", "MPP")
stroma <- c("Fibroblast", "Mesenchymal stromal cell", "Osteoclast")
```
make dot plot
```{r}
# add log2 ratio
prop.out$PropRatioLog2 <- log2(prop.out$PropRatio)
prop.out %>%
        # filter(P.Value < 0.05) %>%
        # sort by PropRatioLog2 for ggplot
        arrange(desc(PropRatioLog2)) %>%
        mutate(BaselineProp.clusters = factor(BaselineProp.clusters, levels = BaselineProp.clusters)) %>%
        # make a dot plot with ggplot geom_point
        ggplot(aes(x = PropRatioLog2, y = BaselineProp.clusters)) +
        scale_size(trans = "reverse", breaks = c(0.05, 0.1, 0.5, 0.75)) +

        geom_point(aes(size = P.Value, color = I(ifelse(P.Value < 0.05, "green",
                                                        ifelse(P.Value < 0.1, "yellow", "red"))))) +
        theme_bw() +

        # theme(legend.position = "none") +
        labs(title = "Cell type distribution") +
        #axis title
        xlab("log2 ratio") +
        ylab("Cell type") -> dotplot
# dotplot
# same with propeller_asin.out
propeller_asin.out$PropRatioLog2 <- log2(propeller_asin.out$PropRatio)
propeller_asin.out$M_F_Log2Ratio <- log2(propeller_asin.out$PropMean.M / propeller_asin.out$PropMean.F)
propeller_asin.out$sign <- ifelse(propeller_asin.out$P.Value < 0.05, "less_0.05",
                                  ifelse(propeller_asin.out$P.Value < 0.1, "less_0.1", "above_0.1"))
propeller_asin.out$lineages <- ifelse(propeller_asin.out$BaselineProp.clusters %in% lymphoid_lineage, "Lymphoid",
                                      ifelse(propeller_asin.out$BaselineProp.clusters %in% gmp_lineage, "Granulocyte-Monocyte",
                                             ifelse(propeller_asin.out$BaselineProp.clusters %in% mep_lineage, "Megakaryocyte-Erythroid",
                                                    ifelse(propeller_asin.out$BaselineProp.clusters %in% dendritic_cell_lineage, "Dendritic",
                                                           ifelse(propeller_asin.out$BaselineProp.clusters %in% early_progenitor_cells, "Early progenitors",
                                                                  ifelse(propeller_asin.out$BaselineProp.clusters %in% stroma, "Stroma",
                                                                         "Others"))))))
propeller_asin.out %>%
        # filter(P.Value < 0.05) %>%
        # sort by PropRatioLog2 for ggplot
        arrange(desc(M_F_Log2Ratio)) %>%
        mutate(BaselineProp.clusters = factor(BaselineProp.clusters, levels = BaselineProp.clusters)) %>%
        # make a dot plot with ggplot geom_point
        ggplot(aes(x = M_F_Log2Ratio, y = BaselineProp.clusters,
                   color = lineages)) +
        geom_point(
                # bigger point size
                size = 6, aes(alpha= sign)
        ) +
        scale_alpha_manual(values = c(1, 0.5, 0.25),
                           labels = c("P < 0.05", "P < 0.1", "P > 0.1"),
                           breaks = c("less_0.05", "less_0.1", "above_0.1"),
                           name = "P value") +
        geom_vline(xintercept = 0, linetype = "longdash", color = "grey",
                   linewidth = 1.5, ) +

        theme_bw() +

        # theme(legend.position = "none") +
        # axis text labels size
        theme(axis.title = element_text(size = 20),
              axis.text = element_text(size = 15),
              legend.title = element_text(size = 20),
              legend.text = element_text(size = 15)) +
        # legend position
        labs(title = "Cell type proportion distribution",
             color = "Lineages") +
        # add ggplot legend
        # axis limits
        xlim(c(-2.5, 2.5)) +

        #axis title
        xlab("Log2(Male/Female)") +
        ylab("Cell type") -> dotplot_asin
dotplot_asin
# save pdf
ggplot2::ggsave(file = "dotplot_asin.pdf", plot = dotplot_asin, width = 10, height = 10, units = "in", dpi = 600)
ggsave(file = "dotplot_asin.png", plot = dotplot_asin, width = 10, height = 10, units = "in", dpi = 600)
```

Plot freq m vs f
```{r}
plot(prop.out$PropMean.M, prop.out$PropMean.F)
# with ggplot
prop.out %>%
  ggplot(aes(x = PropMean.M, y = PropMean.F)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  # add labels
  geom_text(aes(label = BaselineProp.clusters), hjust = 0, vjust = 0) +
  labs(title = "Cell type distribution") -> freq_plot
freq_plot
# log2 ratio
plot(log(prop.out$PropMean.M), log(prop.out$PropMean.F))
lines(c(0, 0), c(1, 1))
# with ggplot
prop.out %>%
  ggplot(aes(x = log(PropMean.M), y = log(PropMean.F))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  # add labels
  geom_text_repel(aes(label = BaselineProp.clusters), hjust = 0, vjust = 0) +
  labs(title = "Cell type distribution") -> freq_plot
freq_plot
# only show progenitors
prop.out %>%
  filter(BaselineProp.clusters %in% progenitor_cells | BaselineProp.clusters %in% dendritic_cells) %>%
  ggplot(aes(x = log(PropMean.M), y = log(PropMean.F))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  # add labels
  geom_text_repel(aes(label = BaselineProp.clusters), hjust = 0, vjust = 0) +
  labs(title = "Cell type distribution") -> freq_plot
freq_plot
```

# now with simplified_ct
Not for just progenitors
```{r, eval = FALSE}
propeller(clusters = meta.data$simplified_ct, sample = meta.data$sample, group = meta.data$Predicted_sex) -> sct_prop.out
sct_prop.out
sct_prop.out$PropRatioLog2 <- log2(sct_prop.out$PropRatio)
sct_prop.out %>%
  # filter(P.Value < 0.05) %>%
  # sort by PropRatioLog2 for ggplot
  arrange(desc(PropRatioLog2)) %>%
  mutate(BaselineProp.clusters = factor(BaselineProp.clusters, levels = BaselineProp.clusters)) %>%
  # make a dot plot with ggplot geom_point
  ggplot(aes(x = PropRatioLog2, y = BaselineProp.clusters)) +
  geom_point(aes(size = P.Value, color = I(ifelse(P.Value < 0.05, "green",
                                                ifelse(P.Value < 0.1, "yellow", "red"))))) +
  scale_size(trans = "reverse", breaks = c(0.05, 0.1, 0.2, 0.5, 0.75)) +
  theme_bw() +
  # theme(legend.position = "none") +
  labs(title = "Cell type distribution") -> sct_dotplot
sct_dotplot
```

# issues

when taking only the progenitors from the start, too few cells are left for the analysis. This creates issues during the scaling function.
Maybe we should focus on other datasets.
```{r}
rna.data@meta.data %>%
filter(simplified_ct == "Progenitor cells") %>%
group_by(sample, projectId) %>%
summarise(n=n()) -> counts
counts
# change NA in projectId to HCA
counts$projectId[is.na(counts$projectId)] <- "HCA"
dittoBarPlot(subset(rna.data, subset = simplified_ct == "Progenitor cells"), var="ct", group.by="sample")
dittoBarPlot(subset(rna.data, subset = simplified_ct == "Progenitor cells"), var="ct", group.by="sample", scale = "count")
# stacked counts
counts %>%
  ggplot(aes(x = sample, y = n)) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  # facet by projectId
    facet_wrap(~projectId, scales="free") +

  labs(title = "Progenitor cells counts") -> progenitor_counts
progenitor_counts
```
