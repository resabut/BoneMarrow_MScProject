---
title: "Quality Control from DISCO Data"
output: html_notebook
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# do not include plots
knitr::opts_chunk$set(fig.show = "hide")
```


# Download data
```{r download data, eval = FALSE}
# download data
dir.create("data")
dir.create("data/DISCO")
# if it doesn't exist, download data
if (!file.exists("data/DISCO/disco_bone_marrow_v2.0.rds")) {
  download.file("https://zenodo.org/record/7615517/files/disco_bone_marrow_v2.0.rds?download=1",
                destfile = "data/DISCO/adisco_bone_marrow_v2.0.rds")
}
```

This should work but it fails. I did a manual download via bash:
```
wget https://zenodo.org/record/7615517/files/disco_bone_marrow_v2.0.rds?download=1
mv disco_bone_marrow_v2.0.rds?download=1 data/DISCO/disco_bone_marrow_v2.0.rds
```

# Load
## load packages
```{r load packages, message=FALSE, warning=FALSE}
library(Seurat)
library(dplyr)
library(ggplot2)
library(tidyr)
library(dittoSeq)
library(patchwork)
library(clustree)
```

## load data
```{r load data}

# load data
bm <- readRDS("data/DISCO/disco_bone_marrow_v2.0.rds")
# fix empty data slot
bm@assays$RNA@data <- bm@assays$RNA@counts
```

The data slot is empty for some reason, so we need import it from the counts slot.



# Pre-processing
## explore metadata
```{r explore metadata}
# explore metadata
colnames(bm@meta.data) -> metadata_names
metadata_names

# see all projects
bm@meta.data %>% distinct(project_id, platform, cell_sorting) -> projects
projects

# see individuals
bm@meta.data %>%
  distinct(project_id, subject_id, sample_id, gender, age,) -> indiv.metadata
indiv.metadata

# plot ages in histogram
indiv.metadata %>%
  ggplot(aes(x = age)) +
  geom_histogram(bins = 10) +
    # title
    labs(title = "Age distribution for all datasets",
         x = "Age (y)",
         y = "Count") +
          # caption
            labs(caption = "fetal samples are not shown in the histogram, they have missining info") -> age_hist_alldata
age_hist_alldata
```

0 age is because fetal samples, they are not shown in the histogram
# QC metrics
## explore QC metrics
```{r explore QC metrics}
# plot QC metrics
VlnPlot(bm, features = c("nFeature_RNA", "nCount_RNA"),
        group.by= "project_id",
        ncol = 2) -> qc_metrics_alldata
qc_metrics_alldata
```

# simplify cell type
## see cell types
```{r see cell types}
# see cell types
bm@meta.data %>%
  distinct(ct, project_id) -> celltypes
celltypes
# id column from 1 to nrow
celltypes$id <- 1
# make a matrix that maps if ct is in project_id
celltypes %>%
  pivot_wider(names_from = project_id, values_from = id) -> celltypes_wider
celltypes_wider

# print the list
celltypes %>%
distinct(ct) %>%
  pull(ct) -> celltypes_list
celltypes_list
```
## simplify cell types
```{r simplify cell types}
# some major groups
b_cells <- c("Naive B cell", "Memory B cell", "Plasma cell", "preB cell", "preB cell (cycling)", "proB cell", "proB cell (cycling)")
t_cells <- c("Naive CD8 T cell", "Effector/Memory CD4 T cell", "Naive CD4 T cell",
             "GZMK+ CD8 T cell", "Gamma-delta T cell", "IFN-activated T cell", "Treg", "GZMB+ CD8 T cell", "MAIT")
nk_cells <- c("CD16+ NK", "Tissue-resident NK cell", "CD56+ NK")
erythrocytes <- c("Early SOX4+ erythroblast", "Late hemoglobin+ erythroblast", "Fetal HBG+ erythrocyte",
                  "Intermediate EPCAM+ erythroblast", "Erythrocyte")
monocytes <- c("CD14+MHCIIhigh monocyte", "CD14+MHCIIlow monocyte", "CD16+ monocyte")
neutrophils <- c("S100A+ preNeutrophil (cycling)", "S100A+ preNeutrophil", "Metamyelocyte/Band neutrophil",
                 "Neutrophil", "Promyelocyte", "Myelocyte")
dendritic_cells <- c("pre-pDC (lymphoid origin)", "pre-pDC (myeloid origin)", "cDC2", "cDC2 (cycling)", "cDC1", "pDC")
megakaryocytes <- c("Megakaryocyte", "Megakaryocyte progenitor")
platelets <- "Platelet"
hsc <- "HSC"
progenitor_cells <- c("CLP", "CMP", "GMP", "MEP", "MPP", "CDP")
plasma_cells <- "Plasma cell"
macrophages <- c("Macrophage", "CD16+ monocyte")
mast_cells <- "Mast cell"
ilc <- "ILC"
mesenchymal_cells <- c("Fibroblast", "Mesenchymal stromal cell")
osteoclasts <- "Osteoclast"
T_NK <- "T/NK cell (cycling)"

# add a column with the simplified cell type name

simplified_ct <- ifelse(bm$ct %in% b_cells, "B cells",
                        ifelse(bm$ct %in% t_cells, "T cells",
                               ifelse(bm$ct %in% nk_cells, "NK cells",
                                      ifelse(bm$ct %in% erythrocytes, "Erythrocytes",
                                             ifelse(bm$ct %in% monocytes, "Monocytes",
                                                    ifelse(bm$ct %in% neutrophils, "Neutrophils",
                                                           ifelse(bm$ct %in% dendritic_cells, "Dendritic cells",
                                                                  ifelse(bm$ct %in% megakaryocytes, "Megakaryocytes",
                                                                         ifelse(bm$ct %in% platelets, "Platelets",
                                                                                ifelse(bm$ct %in% hsc, "HSC",
                                                                                       ifelse(bm$ct %in% progenitor_cells, "Progenitor cells",
                                                                                              ifelse(bm$ct %in% plasma_cells, "Plasma cells",
                                                                                                     ifelse(bm$ct %in% macrophages, "Macrophages",
                                                                                                            ifelse(bm$ct %in% mast_cells, "Mast cells",
                                                                                                                   ifelse(bm$ct %in% ilc, "ILC",
                                                                                                                          ifelse(bm$ct %in% mesenchymal_cells, "Mesenchymal cells",
                                                                                                                                 ifelse(bm$ct %in% osteoclasts, "Osteoclasts",
                                                                                                                                        ifelse(bm$ct %in% T_NK, "T/NK cells",
                                                                                                                                        "Unknown"))))))))))))))))))

bm <- AddMetaData(bm, metadata = simplified_ct, col.name = "simplified_ct")

# check
```




# Subset
## subset for HCA

```{r subset for HCA}
bm.HCA <- subset(bm, subset = project_id == "HCA_HematopoieticImmuneCellAtlas")
# check subset
bm.HCA@meta.data %>%
  distinct(project_id, subject_id, sample_id, gender, age)
```

## subset for "GSE120221"
```{r subset for "GSE120221"}
bm.GSE120221 <- subset(bm, subset = project_id == "GSE120221")
# check subset
bm.GSE120221@meta.data %>%
  distinct(project_id, subject_id, sample_id, gender, age)
```
## subset for unsorted cells

In this case I will subset for 3 datasets that have:
- Over 5 individuals
- Not sorted by cell markers

These are the datasets:
- HCA_HematopoieticImmuneCellAtlas
- GSE120221
- GSE185381
```{r subset for unsorted cells}
project_id_list <- c("HCA_HematopoieticImmuneCellAtlas", "GSE120221", "GSE185381")
bm.unsorted <- subset(bm, subset = project_id %in% project_id_list)
# check subset
bm.unsorted@meta.data %>%
distinct(project_id, subject_id, sample_id, gender, age)
```
### add sex (gender) metadata

```{r sex and age metadata}
sex_df <- read.csv("data/unsorted/GSE120221.csv", header = TRUE, sep = ",")
# get sample - cell id metadata
sample_df <- bm.unsorted@meta.data %>%
  select(sample_id, gender) -> sample_df
# save rownames (cell names) as a column
rownames(sample_df) -> sample_df$cell_ids
# left join
sample_df %>%
  left_join(sex_df, by = c("sample_id" = "sample")) -> sex_cell_df
# add rownames
rownames(sex_cell_df) <- sex_cell_df$cell_ids
# delete cell_ids column
sex_cell_df %>%
        select(-cell_ids) %>%
        # combine sex and gender columns
        mutate(gender = coalesce(sex, gender)) -> sex_cell_df
# add metadata to Seurat object
bm.unsorted[["gender"]]<- sex_cell_df$gender
# check if NA values are present in age and sex columns
sum(is.na(bm.unsorted[['gender']]))
bm.unsorted@meta.data %>%
distinct(project_id, subject_id, sample_id, gender, age)
```

### add age_groups metadata

```{r age_groups metadata}

# add age_groups metadata
# under and over 45
bm.unsorted <- AddMetaData(bm.unsorted, metadata = ifelse(bm.unsorted$age < 45, "under 45", "over 45"), col.name = "age_groups")
# check
bm.unsorted@meta.data %>% distinct(age_groups)
```



### change project_id to shorter names

```{r change project_id to shorter names, eval = FALSE}
# do the same but with if else statements
short_proj_id <- ifelse(bm.unsorted$project_id == "HCA_HematopoieticImmuneCellAtlas", "HCA",
                        ifelse(bm.unsorted$project_id == "GSE120221", "Oejten",
                              ifelse(bm.unsorted$project_id == "GSE185381", "Nadorp-AML", "")))
bm.unsorted <- AddMetaData(bm.unsorted, metadata = short_proj_id, col.name = "short_proj_id")
```
# Pipeline

## Choose dataset
Choose the dataset that you want to run the pipeline on.
In this case, bm.unsorted data is chosen.
```{r choose dataset}
data <- bm.unsorted
```
## Explore dataset
### Age distribution
```{r age distribution}
# plot age distribution
data@meta.data %>%
        distinct(sample_id, age, short_proj_id) %>%
  ggplot(aes(x = age)) +
  geom_histogram(bins = 10) +
  facet_wrap(~short_proj_id, ncol = 1) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Age distribution",
       x = "Age",
       y = "Count")
```



## QC metrics
### Add QC metrics
```{r add QC metrics}
# add QC metrics
# calculate the number of mitochondrial genes
data <- PercentageFeatureSet(data, pattern = "^MT-", col.name = "percent.mt")
# calculate the number of ribosomal genes
data <- PercentageFeatureSet(data, pattern = "^RPS|^RPL", col.name = "percent.ribo")
```

### Plot QC metrics
```{r plot QC metrics}
# plot QC metrics
VlnPlot(data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.ribo"),
        group.by= "sample_id",
        pt.size = 0, # there are probably way too many points
        ncol = 2) +
        plot_annotation("QC metrics for one dataset") -> qc_plot_sample
qc_plot_sample
# by project_id
VlnPlot(data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.ribo"),
        group.by= "short_proj_id",
        pt.size = 0, # there are probably way too many points
        ncol = 2) +
        plot_annotation("QC metrics for one dataset") +
        # change x labels
        scale_x_discrete(labels = c("HCA_HematopoieticImmuneCellAtlas" = "HCA", "GSE120221" = "Oejten", "GSE185381" = "Nadorp-AML")) -> qc_plot_project
qc_plot_project
```

We can also plot nFeature_RNA against nCount_RNA to see if there are any outliers.
```{r plot nFeature_RNA against nCount_RNA}
# plot nFeature_RNA against nCount_RNA
data %>%
FeatureScatter(
          feature1 = "nFeature_RNA",
          feature2 = "nCount_RNA",
          group.by = "short_proj_id",
        ) +
        plot_annotation("nFeature_RNA against nCount_RNA for one dataset") -> qc_featurescatterplot
qc_featurescatterplot
```

## Filter cells
Let's filter out cells with low number of features and with high mitochondrial levels.
Following Oejten paper, we will filter out cells with less than 500 features and with more than 8% mitochondrial genes.

```{r filter cells}
# filter cells
data <- subset(data,
               subset = nFeature_RNA > 500 & percent.mt < 8)
```

## Normalisation
Log normalise the data.
```{r normalisation}
# normalise
data <- NormalizeData(data, normalization.method = "LogNormalize", scale.factor = 10000)
```

## Variable features
Find variable features.
```{r variable features}
# find variable features, top 2000
data <- FindVariableFeatures(data, selection.method = "vst", nfeatures = 2000)
```

We can also plot a vulcano plot with labels
```{r plot vulcano plot}
# we can look at the top 10 variable features
top10VarFeat <- head(VariableFeatures(data), 10)
top10VarFeat
# plot vulcano plot
LabelPoints(plot=VariableFeaturePlot(data),
            points = top10VarFeat, repel = TRUE) +
            plot_annotation("Vulcano plot of variable features") -> vulcanoVarFeat_plot
vulcanoVarFeat_plot
```

The top 10 are:
IGHG1: Encodes for the IgG1 antibody, which is involved in opsonization and complement activation. It is primarily produced by plasma cells and expressed in plasma cells.
IGHG2: Encodes for the IgG2 antibody, which is involved in opsonization and complement activation. It is primarily produced by plasma cells and expressed in plasma cells.
IGHG3: Encodes for the IgG3 antibody, which is involved in opsonization and complement activation. It is primarily produced by plasma cells and expressed in plasma cells.
IGHGP: Encodes for the gamma polypeptide chain of the IgG antibody and is expressed in plasma cells.
IGHA1: Encodes for the alpha chain of the IgA antibody, which is primarily found in mucosal secretions and plays a role in mucosal immunity. It is expressed in plasma cells, as well as epithelial cells and some immune cells such as neutrophils and monocytes.
IGLC2: Encodes for the lambda light chain of the Ig antibody and is expressed in plasma cells.
IGLC3: Encodes for the lambda light chain of the Ig antibody and is expressed in plasma cells.
IGKC: Encodes for the kappa light chain of the Ig antibody and is expressed in plasma cells.
HBG2: Encodes for the beta-globin chain of hemoglobin and is expressed in erythrocytes (red blood cells).
JCHAIN: Encodes for the joining chain of IgA and IgM antibodies, which is involved in their polymerization. It is expressed in plasma cells, as well as some epithelial cells.


They are expressed very highly in only a subset of cells, hence their variety.
## Scale data
Scale the data.
```{r scale data}
# multithreaded scaling
plan("sequential")
options(future.globals.maxSize = 5000 * 1024^2) # allocates 10GB memory
# scale data
data <- ScaleData(data, features = rownames(data)) # scales all the features
# for only variable features
# data <- ScaleData(data, features = VariableFeatures(object = data))
```
### save after scaling
```{r save after scaling, eval = FALSE}
# save after scaling
saveRDS(data, file = "data/unsorted/unsorted_scaled.rds", compress = FALSE)
```

### Load
```{r load, eval = FALSE}
# load
data <- readRDS(file = "data/unsorted/unsorted_scaled.rds")
```

## Linear dimensional reduction
Run PCA.
```{r linear dimensional reduction}
# run PCA
data <- RunPCA(data, features = VariableFeatures(object = data),
               verbose = FALSE)

# print the first 5 PCs and the top 5 genes in each direction
print(data[["pca"]], dims = 1:5, nfeatures = 5)
```

And then we plot it
```{r plot PCA}
# plot PCA loadings
data %>%
VizDimLoadings(
  dims = 1:2,
  reduction = "pca") +
  ggtitle("PCA Loadings") -> pca_loadings_plot
pca_loadings_plot
# plot PCA
data %>%
        DimPlot(
          reduction = "pca",
          group.by = "sample_id",
          label = TRUE
        ) +
        ggtitle("PCA coloured by sample_id")-> pca_plot_sample
pca_plot_sample
# by dataset
data %>%
        DimPlot(
          reduction = "pca",
          group.by = "short_proj_id",
          label = TRUE
        ) +
        ggtitle("PCA coloured by short_proj_id")-> pca_plot_dataset
pca_plot_dataset
```

We can also plot a heatmap of the PCs
```{r plot heatmap of PCs}
DimHeatmap(data,
dims = 1:6, # plots the first 5 PCs
balanced = TRUE, # scales the colors so that the most negative and most positive values are white
fast = FALSE, # forces ggplot return
cells = 500) +
 plot_annotation("Heatmap for the first 6 PCs")-> pca_heatmap_plot
pca_heatmap_plot
```



## Dimensionality of the data
We can check the dimensionality of the data by looking at how much variance the PCs explain.
```{r check dimensionality}
ElbowPlot(data, ndims = 50) +
ggtitle("Elbow plot")-> elbow_plot
elbow_plot
```

## Clustering
Based on the Elbow plot, we can see that the first 20 PCs explain most of the variance.
We will use the first 10 PCs for clustering.
```{r}
n_pcs <- 20
```

First we find neighbors among the cells.
```{r find neighbours}
data <- FindNeighbors(data, dims = 1:n_pcs)
```

Then we run the clustering algorithm.
```{r run clustering algorithm}
# Select a range of resolutions

resolution.range <- seq(from = 0, to = 1, by = 0.25)

data <- FindClusters(data, resolution = resolution.range)
```


And then we plot the clusters.
```{r plot clusters}
# clustree
clustree(data, color = "seurat_clusters") +
  ggtitle("Clustree") -> clustree_plot
clustree_plot
data %>%
        DimPlot(
          reduction = "pca",
          group.by = "seurat_clusters",
          label = TRUE
        ) -> cluster_pca_plot
cluster_pca_plot
# we compare with the cell_type id
data %>%
        DimPlot(
          reduction = "pca",
          group.by = "ct",
          label = TRUE
        ) +
        # legend at the bottom, and small
        theme(legend.position = "bottom", legend.text = element_text(size = 8)) -> cluster_celltype_pca_plot

cluster_celltype_pca_plot
```

## Non-linear dimensional reduction
We can also run UMAP and see how the clusters look like.
The number of dimensions goes according to the number of PCs we used for clustering.
```{r run UMAP}
data <- RunUMAP(data,
  dims = 1:n_pcs)
```

And then we plot the clusters.
```{r plot clusters}
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "seurat_clusters",
          label = TRUE
        ) -> cluster_umap_plot
cluster_umap_plot
# we compare with the cell_type id
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "simplified_ct",
          label = TRUE
        ) +
        # legend at the bottom, and small
        theme(legend.position = "bottom", legend.text = element_text(size = 8)) -> cluster_celltype_umap_plot
cluster_celltype_umap_plot
# also by ct
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "ct",
          label = TRUE
        )
cluster_celltype_umap_plot
# also by sample
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "sample_id",
          label = TRUE
        ) -> cluster_sampleid_umap_plot
cluster_sampleid_umap_plot
# and by dataset
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "short_proj_id",
          label = TRUE
        ) -> cluster_dataset_umap_plot
cluster_dataset_umap_plot
# and gender
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "gender",
          label = TRUE
        ) -> cluster_sex_umap_plot
cluster_sex_umap_plot
# and age
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "age",
          label = TRUE
        ) -> cluster_age_umap_plot
cluster_age_umap_plot

# plot by age groups
data %>%
        DimPlot(
          reduction = "umap",
          group.by = "age_groups",
          label = TRUE
        ) -> cluster_age_group_umap_plot
cluster_age_group_umap_plot
```
they do cluster according to cell type, but also dataset, but maybe this is because of age groups.
When dividing by 45, we see that the clusters are more defined by age group.




## Frequency of cell types
### confirm by cluster
```{r frequency of cell types by cluster}
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "seurat_clusters") +
  ggtitle("Simplified cell type frequencies per cluster")-> ct_simpl_clusters
ct_simpl_clusters
# and ct
data %>%
  dittoBarPlot(var = "ct", group.by = "seurat_clusters") +
  ggtitle("Cell type frequencies per cluster")-> ct_clusters
ct_clusters
```
### confirm by sample
```{r frequency of cell types by sample}
# by project
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "sample_id",
               split.by = "short_proj_id", split.adjust = list(scales = "free") ) +
  plot_annotation("Simplified cell type by sample")-> ct_sample_id
ct_sample_id
# by age_groups
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "sample_id",
               split.by = "age_groups", split.adjust = list(scales = "free") ) +
  plot_annotation("Simplified cell type by sample")-> ct_sample_id_age
ct_sample_id_age
```
### by sex (gender)
In this dataset, biological sex is named gender
```{r frequency of cell types by sex}
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "gender")
  plot_annotation("Simplified cell type by sex")-> ct_sex
ct_sex

#split by proj
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "gender",
                 split.by = "short_proj_id", split.adjust = list(scales = "free") ) +
  plot_annotation("Simplified cell type by sex")-> ct_sex_proj
ct_sex_proj

# but only under 45
subset(data, subset = age_groups == "under 45") %>%
  dittoBarPlot(var = "simplified_ct", group.by = "gender",
                 split.by = "short_proj_id", split.adjust = list(scales = "free") ) +
  plot_annotation("Simplified cell type by sex for individuals under 45") -> ct_sex_proj_under45
ct_sex_proj_under45
```

We can also plot it by individual
```{r frequency of cell types by individual}
data %>%
  dittoBarPlot(var = "simplified_ct", group.by = "sample_id", split.by = "gender",
               split.adjust = list(scales = "free"), # removes empty groups
               main = "Simplified cell type by individual and sex"
  ) -> ct_individual
ct_individual
```

## also by cell type
The subtype plots do not calculate frequencies overall, but inside the simplified cell type classes.
See next chunk.
```{r frequency of cell types by cell type}
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per cell type") -> ct_freq_individual_plot
# simplified_ct
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~simplified_ct, scales = "free") +
  labs(title = "Distribution per simplified cell type") -> simplified_ct_freq_individual_plot

# just T cells
data@meta.data %>%
        filter(simplified_ct == "T cells") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per T cell type") -> Tcell_freq_individual_plot

# just monocytes
data@meta.data %>%
        filter(simplified_ct == "Monocytes") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per monocyte type") -> monocyte_freq_individual_plot
# just progenitor cells and HSCs
data@meta.data %>%
        filter(simplified_ct == "Progenitor cells"| simplified_ct == "HSC") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per Progenitor type") -> progenitor_cells_freq_individual_plot
# just B cells
data@meta.data %>%
        filter(simplified_ct == "B cells" | simplified_ct == "Plasma cells") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per B cell type") -> B_cell_freq_individual_plot
# erythrocytes
data@meta.data %>%
        filter(simplified_ct == "Erythrocytes") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution for Erythro lineage") -> eryhtro_freq_individual_plot
# dendritic cells
data@meta.data %>%
        filter(simplified_ct == "Dendritic cells") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per DC type") -> Dendritic_freq_individual_plot
# NK cells
data@meta.data %>%
        filter(simplified_ct == "NK cells") %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per NK type") -> NK_freq_individual_plot

```

For the overall frequencies
```{r frequency of cell types by cell type overall}
# just T cells
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
filter(simplified_ct == "T cells") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per T cell type") -> Tcell_freq_individual_plot

# just monocytes
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "Monocytes") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per monocyte type") -> monocyte_freq_individual_plot
# just progenitor cells and HSCs
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "Progenitor cells" | simplified_ct == "HSC") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per Progenitor type") -> progenitor_cells_freq_individual_plot
# just B cells
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "B cells" | simplified_ct == "Plasma cells") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per B cell type") -> B_cell_freq_individual_plot
# erythrocytes
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "Erythrocytes") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution for Erythro lineage") -> eryhtro_freq_individual_plot
# dendritic cells
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "Dendritic cells") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per DC type") -> Dendritic_freq_individual_plot
# NK cells
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "NK cells") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per NK type") -> NK_freq_individual_plot
# Neutrophils
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct, simplified_ct) %>%
  mutate(pct = n / sum(n)) %>%
                filter(simplified_ct == "Neutrophils") %>%

  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Distribution per NK type") -> Neutrophils_freq_individual_plot
```


We can also see the counts of each cell type
```{r counts of cell types by cell type}
data@meta.data %>%
  group_by(sample_id, gender, age) %>%
  count(ct) %>%
  mutate(pct = n) %>%
  ggplot(aes(x = gender, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~ct, scales = "free") +
  labs(title = "Absolute counts") -> counts_per_celltype_plot
```
### plot with for loop

```{r plot with for loop}
simplified_ct_list <- data@meta.data %>% distinct(simplified_ct)
simplified_ct_plot_list <- list()
Idents(data) <- data$simplified_ct
# plot with for loop
for (i in seq_along(simplified_ct_list$simplified_ct)) {
        cell_type <- simplified_ct_list$simplified_ct[i]
        dittoFreqPlot(data, "ct", sample.by = "sample_id",
                      group.by = "gender",
        color.by= "short_proj_id",
                      cells.use = rownames(data@meta.data)[which(data[["simplified_ct"]] == cell_type)],
        main = paste0(cell_type, " frequency")) -> plot

        assign(paste0(gsub(" ", "_", cell_type), "_plot"), plot)
        simplified_ct_plot_list <- c(simplified_ct_plot_list, mget(paste0(gsub(" ", "_", cell_type), "_plot")))
}
```
to saved them all in a pdf
```{r}
pdf("data/unsorted/young_individual_celltype_distribution.pdf", width = 10, height = 10)
simplified_ct_plot_list
dev.off()
```

## Differential expression
### Plot known markers
From ChatGPT:
B cells: CD19 (also known as B4), CD79A (also known as mb-1)
T cells: CD3D, CD3E
NK cells: NKG7, GNLY (also known as granulysin)
Erythrocytes: HBB (hemoglobin beta), EPB42 (erythrocyte membrane protein band 4.2)
Monocytes: CD14, CD163
Neutrophils: S100A8 (also known as calprotectin), S100A9 (also known as calgranulin B)
Dendritic cells: CD1C (also known as BDCA-1), FLT3 (also known as CD135)
Megakaryocytes: PF4 (platelet factor 4), GP1BA (glycoprotein Ib alpha)
Platelets: PPBP (pro-platelet basic protein), PF4 (platelet factor 4)
HSC (hematopoietic stem cells): CD34, PROM1 (also known as CD133)
Progenitor cells: CD34, FLT3 (also known as CD135)
Plasma cells: IGKC (immunoglobulin kappa constant), IGLL5 (immunoglobulin lambda-like polypeptide 5)
Macrophages: CD68, CD163
Mast cells: CPA3 (carboxypeptidase A3), TPSAB1 (tryptase alpha/beta 1)
ILC (innate lymphoid cells): IL7R (interleukin-7 receptor), KLRB1 (killer cell lectin-like receptor subfamily B member 1)
Mesenchymal cells: CD90 (also known as Thy1), CD105 (also known as endoglin)
Osteoclasts: ACP5 (also known as TRAP), CTSK (cathepsin K)
T/NK cells: CD3D, CD56 (also known as NCAM1)

```{r plot known markers}
# plot known markers for each cell type
markers1 <- c("CD19", "CD79A", "CD3D", "CD3E", "NKG7", "GNLY", "HBB", "EPB42", "CD14", "CD163")
 markers2 <- c("S100A8", "S100A9", "CD1C", "FLT3", "PF4", "GP1BA", "PPBP", "CD34", "PROM1")
  markers3 <- c("IGKC", "IGLL5", "CD68", "CD163", "CPA3", "TPSAB1", "IL7R", "KLRB1")
  markers4 <- c("THY1", "ENG", "ACP5", "CTSK", "CD3D", "NCAM1")
# CD90 is THY1, CD105 is ENG, CD56 is NCAM1
# plot markers
data %>% FeaturePlot(features = markers1, cols = c("yellow", "purple"), reduction = "umap", pt.size = 0.5) -> markers1_plot
data %>% FeaturePlot(features = markers2, cols = c("yellow", "purple"), reduction = "umap", pt.size = 0.5) -> markers2_plot
data %>% FeaturePlot(features = markers3, cols = c("yellow", "purple"), reduction = "umap", pt.size = 0.5) -> markers3_plot
data %>% FeaturePlot(features = markers4, cols = c("yellow", "purple"), reduction = "umap", pt.size = 0.5) -> markers4_plot
markers1_plot
markers2_plot
markers3_plot
markers4_plot
# save to png with ggplot
ggsave("data/unsorted/markers1", markers1_plot, width = 11, height = 8.5)
ggsave("data/unsorted/markers2", markers2_plot, width = 11, height = 8.5)
ggsave("data/unsorted/markers3", markers3_plot, width = 11, height = 8.5)
ggsave("data/unsorted/markers4", markers4_plot, width = 11, height = 8.5)

```











# Save

## RDS file
```{r save, eval = FALSE}
# save
saveRDS(data, file = "data/unsorted/unsorted_clustered.rds", compress = FALSE)
```
to load it
```{r load, eval = FALSE}
# load
data <- readRDS("data/unsorted/unsorted_clustered.rds")
```

## plots
```{r save plots, eval = FALSE}
# save all plots to pdf
plot_list <- list(ct_freq_individual_plot, simplified_ct_freq_individual_plot, Tcell_freq_individual_plot, monocyte_freq_individual_plot, progenitor_cells_freq_individual_plot, B_cell_freq_individual_plot, Dendritic_freq_individual_plot, eryhtro_freq_individual_plot, NK_freq_individual_plot, Neutrophils_freq_individual_plot, counts_per_celltype_plot)
pdf("data/unsorted/plots.pdf", width = 11, height = 8.5)
plot_list
dev.off()
```

### save all plots
```{r save plots, eval = FALSE}
# save all plots to pdf
my_ggplot_names <- ls()[which(sapply(ls(),function(x) class(get(x))[2] %in% c("gg", "ggplot")))]
# create a list of all ggplot objects, not just names
my_listed_ggplots <- mget(my_ggplot_names)
# if folder does not exist, create it
if(!dir.exists("formatted/HCA")) dir.create("formatted/HCA")
pdf("formatted/HCA/HCA_HematopoieticImmuneCellAtlas_plots.pdf", width = 11, height = 8.5)
my_listed_ggplots

```

