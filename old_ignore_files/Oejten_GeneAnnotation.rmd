---
title: "R Notebook"
output: pdf_document
---
```{r include = FALSE}
knitr::opts_chunk$set(fig.height = 9, fig.width = 7, fig.crop = FALSE)
```
This is based on the tutorial
https://github.com/IanevskiAleksandr/sc-type

# load libraries and functions

```{r load libraries and functions, echo=FALSE}
rm(list=ls())
suppressMessages(library(dplyr))
suppressMessages(library(Seurat))
suppressMessages(library(HGNChelper))
suppressMessages(library(openxlsx))
suppressMessages(library(dittoSeq))

source("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R")
source("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_score_.R")

```


# load data

```{r load data}
# load data
bm <- readRDS("data/seurat_obj/Oejten_seurat_QC.rds")
# load gene database, provided
gs_list <- gene_sets_prepare("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_short.xlsx", "Immune system")
```

# run sc-type

```{r run sc-type, echo=FALSE}
# run sc-type
es.max <- sctype_score(scRNAseqData = bm[["RNA"]]@scale.data,
                       scaled = TRUE,
                       gs = gs_list$gs_positive,
                       gs2 = gs_list$gs_negative)
```


# merge by cluster

```{r merge by cluster 2nd, echo=FALSE}

cL_resutls <- do.call("rbind", lapply(unique(bm@meta.data$seurat_clusters), function(cl){
    es.max.cl <- sort(rowSums(es.max[ ,rownames(bm@meta.data[bm@meta.data$seurat_clusters==cl, ])]), decreasing = !0)
    head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(bm@meta.data$seurat_clusters==cl)), 10)
}))
# save results to csv
write.csv(cL_resutls, "results/tables/cL_resutls.csv")
# get top score for each cluster
sctype_scores <- cL_resutls %>% group_by(cluster) %>% top_n(n = 1, wt = scores)

# set low-confident (low ScType score) clusters to "unknown"
sctype_scores$type[as.numeric(as.character(sctype_scores$scores)) < sctype_scores$ncells/2] <- "Unknown"
print(sctype_scores[,1:4])
# save results to csv and xlsx
write.csv(sctype_scores, "results/tables/sctype_scores.csv")
write.xlsx(sctype_scores, "results/tables/sctype_scores.xlsx")
```

# plot on umap

```{r plot on umap 2nd , echo=FALSE}
bm@meta.data$sctypeclassif <- ""
for(j in unique(sctype_scores$cluster)){
  cl_type <- sctype_scores[sctype_scores$cluster==j,]
  bm@meta.data$sctypeclassif[bm@meta.data$seurat_clusters == j] <- as.character(cl_type$type[1])
}

bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'sctypeclassif') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            ) +
            # change title
            ggtitle("sc-type") -> umap_celltype_plot
umap_celltype_plot
# save plot to png
ggsave("results/figures/umap_celltype_plot.png", umap_celltype_plot, width = 10, height = 10)
```

# plot cell type stats
```{r plot cell type stats, echo=FALSE}
# plot cell type frequency in seurat object metadata
# by sample_id
bm %>%
  dittoBarPlot(var = "sctypeclassif", group.by = "sample") +
   theme(legend.text = element_text(size = 10),
         legend.position = "bottom"
   )-> celltype_freq_plot
celltype_freq_plot
# save plot to png
ggsave("results/figures/celltype_freq_plot.png", celltype_freq_plot, width = 10, height = 10)

```


# group into lineages
```{r group into lineages, echo=FALSE}
# get unique cell types
bm@meta.data %>%
  dplyr::select(sctypeclassif) %>%
  unlist() %>%
    unique() -> cell_types
# group into lineages
bm[["lineage"]] <- ""
# create lists
myeloid_lineage <- c("Myeloid Dendritic cells", "Neutrophils", "Classical Monocytes", "Non-classical monocytes", "Basophils", "Neutrophils")
lymphoid_lineage <- c("Plasma B cells", "Immature B cells", "Pro-B cells", "Pre-B cells", "Naive CD4+ T cells", "Naive CD8+ T cells", "CD8+ NKT-like cells", "Plasmacytoid Dendritic cells",
                      "Memory CD4+ T cells", "Memory CD8+ T cells", "Naive B cells")
erythroid_lineage <- c("Erythroid-like and erythroid precursor cells", "Endothelial", "Platelets")

# Create a vector of lineage assignments for each cell based on its cell type
lineage_assignments <- ifelse(bm$sctypeclassif %in% myeloid_lineage, "Myeloid",
                              ifelse(bm$sctypeclassif %in% lymphoid_lineage, "Lymphoid",
                                     ifelse(bm$sctypeclassif %in% erythroid_lineage, "Erythroid",
                                            ifelse(bm$sctypeclassif %in% "Progenitor cells", "Progenitor cells",
                                                   "Unknown"))))
# Add the lineage metadata column to the Seurat object
bm <- AddMetaData(bm, metadata = lineage_assignments, col.name = "lineage")


# plot lineage frequency in seurat object metadata
# by sample_id
bm %>%
  dittoBarPlot(var = "lineage", group.by = "sample") -> lineage_freq_plot
lineage_freq_plot
# save plot to png
ggsave("results/figures/lineage_freq_plot.png", lineage_freq_plot, width = 10, height = 10)
```

Samples G and P have a lot more erythroid lineage cells than the other samples proportionally.
## individual clusters
```{r individual clusters, echo=FALSE}
# plot seurat_cluster frequency in seurat object metadata
# by sample
bm %>%
  dittoBarPlot(var = "seurat_clusters", group.by = "sample") -> lineage_freq_plot
lineage_freq_plot
# save plot to png
ggsave("results/figures/seurat_clusters_by_sample_frequency.png", lineage_freq_plot, width = 10, height = 10)
# save to pdf
ggsave("results/figures/seurat_clusters_by_sample_frequency.pdf", lineage_freq_plot, width = 10, height = 10)

```
It is P again with cluster 14 which is an erythroid cluster mapping to the lymphoid lineage.

# plot lineages on umap
```{r plot lineages on umap, echo=FALSE}
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'lineage') +
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )-> umap_lineage_plot
umap_lineage_plot
# save plot to png
ggsave("results/figures/umap_lineage_plot.png", umap_lineage_plot, width = 10, height = 10)
```

A small subset of erythroid clusters with the lymphoid cluster in the middle.

# lineage frequency by sex
```{r}
bm %>%
  dittoBarPlot(var = "lineage", group.by = "sex") -> sexlineage_freq_plot
sexlineage_freq_plot
bm %>%
  dittoBarPlot(var = "sctypeclassif", group.by = "sex") -> sexcell_freq_plot
sexcell_freq_plot
# save plot to png
ggsave("results/figures/sexlineage_freq_plot.png", sexlineage_freq_plot, width = 10, height = 10)
```

We can see the usual CD8+ dominance in males

## compare umap by sex
```{r compare umap by sex}
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'lineage',
            split.by = 'sex') +
    theme(legend.text = element_text(size = 10),
          legend.position = "bottom"
    )-> sex_split_umap
sex_split_umap
# umap with just sex
bm %>%
        DimPlot(reduction = "umap",
                label=TRUE,
                repel=TRUE,
                group.by= "sex"
        ) +
        theme(legend.text = element_text(size = 10),
              legend.position = "bottom"
        )-> sex_umap
sex_umap
```


# save seurat object
```{r save seurat object, echo=FALSE}
# save seurat object
saveRDS(bm, file = "data/seurat_obj/Oejten_annotated.rds", compress = FALSE)
print("seurat object saved")
# print time
print(Sys.time())
```

# load seurat object
```{r load seurat object, echo=FALSE}
# load seurat object
bm <- readRDS("data/seurat_obj/Oejten_annotated.rds")
print("seurat object loaded")
# print time
print(Sys.time())
```


# plot cell type frequency by sample grouped by sex
```{r}
bm %>%
  dittoBarPlot(var = "sctypeclassif", group.by = "sample", split.by = "sex" ) -> sexcell_freq_plot

sexcell_freq_plot
```



# Annotation with sc-type and Conde et al from Immcluster


## load seurat object
```{r load seurat object bis, echo=FALSE}
# load seurat object
bm <- readRDS("data/seurat_obj/Oejten_annotated.rds")
print("seurat object loaded")
# print time
print(Sys.time())
```
## load marker gene
```{r load marker gene, echo=FALSE}
# read xlsx
gs_list <- gene_sets_prepare("data/marker_gene_lists/normal_BMA_markerInfor-sc-type.xlsx", "normal_BMA")
#gs_list <- read.xlsx("data/marker_gene_lists/normal_BMA_markerInfor-sc-type.xlsx",
#                     sheet = 1, colNames = TRUE)

```
## run sc-type

```{r run sc-type 2nd, echo=FALSE}
# run sc-type
es.max <- sctype_score(scRNAseqData = bm[["RNA"]]@scale.data,
                       scaled = TRUE,
                       gs = gs_list$gs_positive,
                       gs2 = gs_list$gs_negative)
```


## merge by cluster

```{r merge by cluster bis, echo=FALSE}

cL_resutls <- do.call("rbind", lapply(unique(bm@meta.data$seurat_clusters), function(cl){
    es.max.cl <- sort(rowSums(es.max[ ,rownames(bm@meta.data[bm@meta.data$seurat_clusters==cl, ])]), decreasing = !0)
    head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(bm@meta.data$seurat_clusters==cl)), 10)
}))
# save results to csv
write.csv(cL_resutls, "results/tables/cL_resutls_conde.csv")
# get top score for each cluster
sctype_scores <- cL_resutls %>% group_by(cluster) %>% top_n(n = 1, wt = scores)

# set low-confident (low ScType score) clusters to "unknown"
sctype_scores$type[as.numeric(as.character(sctype_scores$scores)) < sctype_scores$ncells/4] <- "Unknown"
print(sctype_scores[,1:4])
# save results to csv and xlsx
write.csv(sctype_scores, "results/tables/sctype_scores_conde.csv")
write.xlsx(sctype_scores, "results/tables/sctype_scores_conde.xlsx")
```


## plot on umap

```{r plot on umap, echo=FALSE}
bm@meta.data$sctypeconde <- ""
for(j in unique(sctype_scores$cluster)){
  cl_type <- sctype_scores[sctype_scores$cluster==j,]
  bm@meta.data$sctypeconde[bm@meta.data$seurat_clusters == j] <- as.character(cl_type$type[1])
}

bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'sctypeconde') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            ) +
            # change title
            ggtitle("sc-type conde") -> umap_celltypeconde_plot
umap_celltypeconde_plot
# save plot to png
ggsave("results/figures/umap_celltypeconde_plot.png", umap_celltypeconde_plot, width = 10, height = 10)
```




# Annotation with sc-type and Qin


## load seurat object
```{r load seurat object 3rd, echo=FALSE}
# load seurat object
bm <- readRDS("data/seurat_obj/Oejten_annotated.rds")
print("seurat object loaded")
# print time
print(Sys.time())
```
## load marker gene
```{r load marker gene qin, echo=FALSE}
# read xlsx
gs_list <- gene_sets_prepare("data/marker_gene_lists/Qin_markers.xlsx", "Bone-Marrow")
#gs_list <- read.xlsx("data/marker_gene_lists/normal_BMA_markerInfor-sc-type.xlsx",
#                     sheet = 1, colNames = TRUE)

```
## run sc-type

```{r run sc-type bis, echo=FALSE}
# run sc-type
es.max <- sctype_score(scRNAseqData = bm[["RNA"]]@scale.data,
                       scaled = TRUE,
                       gs = gs_list$gs_positive,
                       gs2 = gs_list$gs_negative)
```


## merge by cluster

```{r merge by cluster, echo=FALSE}

cL_resutls <- do.call("rbind", lapply(unique(bm@meta.data$seurat_clusters), function(cl){
    es.max.cl <- sort(rowSums(es.max[ ,rownames(bm@meta.data[bm@meta.data$seurat_clusters==cl, ])]), decreasing = !0)
    head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(bm@meta.data$seurat_clusters==cl)), 10)
}))
# save results to csv
write.csv(cL_resutls, "results/tables/cL_resutls_qin.csv")
# get top score for each cluster
sctype_scores <- cL_resutls %>% group_by(cluster) %>% top_n(n = 1, wt = scores)

# set low-confident (low ScType score) clusters to "unknown"
sctype_scores$type[as.numeric(as.character(sctype_scores$scores)) < sctype_scores$ncells/4] <- "Unknown"
print(sctype_scores[,1:4])
# save results to csv and xlsx
write.csv(sctype_scores, "results/tables/sctype_scores_qin.csv")
write.xlsx(sctype_scores, "results/tables/sctype_scores_qin.xlsx")
```


## plot on umap

```{r plot on umap bis, echo=FALSE}
bm@meta.data$sctypeqin <- ""
for(j in unique(sctype_scores$cluster)){
  cl_type <- sctype_scores[sctype_scores$cluster==j,]
  bm@meta.data$sctypeqin[bm@meta.data$seurat_clusters == j] <- as.character(cl_type$type[1])
}

bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'sctypeqin') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            ) +
            # change title
            ggtitle("sc-type qin") -> umap_celltypeqin_plot
umap_celltypeqin_plot
# save plot to png
ggsave("results/figures/umap_celltypeqin_plot.png", umap_celltypeqin_plot, width = 10, height = 10)
```

## calculate frrequencies

```{r calculate frrequencies, echo=FALSE}
# calculate frrequencies
sctype_freq <- bm@meta.data %>% group_by(sctypeqin) %>% summarise(n = n()) %>% arrange(desc(n))
sctype_freq$freq <- sctype_freq$n/sum(sctype_freq$n)
sctype_freq
# make a pieplot
sctype_freq %>%
    ggplot(aes(x = "", y = freq, fill = sctypeqin)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    theme_void() +
    theme(legend.position = "bottom") +
  # add labels with names
    geom_text(aes(label = sctypeqin), position = position_stack(vjust = 0.5)) +
    ggtitle("sc-type qin") -> sctype_freq_plot
sctype_freq_plot
# save plot to png
ggsave("results/figures/sctypeqin_freq_plot.png", sctype_freq_plot, width = 10, height = 10)
```

# save seurat object
This overwrites the seurat object with the new annotations.
```{r save seurat object bis, echo=FALSE}
# save seurat object
saveRDS(bm, file = "data/seurat_obj/Oejten_annotated.rds", compress = FALSE)
print("seurat object saved")
# print time
print(Sys.time())
```


tissueType	cellName	geneSymbolmore1
Bone-Marrow	HSPC	AVP CD34
Bone-Marrow	EPC	GYPA KLF1
Bone-Marrow	Mk	PF4 GP9
Bone-Marrow	Myeolocyte	ELANE MPO
Bone-Marrow	Monocyte	LYZ CD14
Bone-Marrow	B cell	CD79A
Bone-Marrow	T cell	CD3D
Bone-Marrow	NK	FCGR3A NCAM1
Bone-Marrow	Stromal cell	CXCL12 COL6A1



```{r}
# plot on umap with Feature plot
bm <- SetIdent(bm, value = "sctypeqin")
bm %>%
    FeaturePlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            features = c("CD34", "CD79A", "CD3D", "FCGR3A", "NCAM1", "CXCL12", "COL6A1", "ELANE", "MPO", "LYZ", "CD14", "AVP", "GYPA", "KLF1", "PF4", "GP9"),
            cols = c("grey", "red")) -> umap_celltypeqin_plot
umap_celltypeqin_plot
#save to pdf and png
ggsave("results/figures/umap_celltypeqin_plot.pdf", umap_celltypeqin_plot, width = 10, height = 10)
ggsave("results/figures/umap_celltypeqin_plot.png", umap_celltypeqin_plot, width = 10, height = 10)

```

```{r}
# umap with clusters of 0.5 resolution
bm <- SetIdent(bm, value = "RNA_snn_res.0.5")
#plot on umap
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'RNA_snn_res.0') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'RNA_snn_res.0.25') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'RNA_snn_res.0.5') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'RNA_snn_res.0.75') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )
bm %>%
    DimPlot(reduction = "umap",
            label = TRUE,
            repel = TRUE,
            group.by = 'RNA_snn_res.1') +
            # change legend text size and put at the bottom
            theme(legend.text = element_text(size = 10),
                  legend.position = "bottom"
            )

```


[1] "USP9Y"     "EIF1AY"    "TTTY10"    "TTTY14"    "KDM5D"     "RPS4Y1"
 [7] "ZFY"       "ZFY-AS1"   "DDX3Y"     "UTY"       "TMSB4Y"    "NLGN4Y"
[13] "LINC00278" "RPS4Y2"    "PCDH11Y"
# make sure that the sex is correct
```{r idk, eval = FALSE}
y_genes <- c("USP9Y", "EIF1AY", "TTTY10", "TTTY14", "KDM5D", "RPS4Y1", "ZFY", "ZFY-AS1", "DDX3Y", "UTY", "TMSB4Y", "NLGN4Y", "LINC00278", "RPS4Y2", "PCDH11Y")
y_bm <- subset(bm, features = y_genes)
y_bm <- RunPCA(y_bm, features = y_genes)
DimPlot(y_bm, reduction = "pca", group.by = "sample")
# umap
y_bm <- RunUMAP(y_bm, dims = 1:5)
DimPlot(y_bm, reduction = "umap", group.by = "sex", label = TRUE, repel = TRUE)
VlnPlot(bm, features = y_genes, group.by = "sex")
# plot average expression of y genes per sample
AverageExpression(y_bm, group.by = "sample") [[1]] -> y_avg
 # transpose y_avg
y_avg <- t(y_avg)
data.frame(y_avg) -> y_avg
# boxplot with ggplot with  y_avg
ggplot(y_avg, aes(x = sample, y = y_avg)) +
    geom_boxplot()

# heatmap

DoHeatmap(subset(y_bm, downsample = 100), features = y_genes, group.by = c("sample","sex")) -> y_heatmap
y_heatmap

# do clustering on y_bm
y_bm <- FindNeighbors(y_bm, dims = 1:5)
y_bm <- FindClusters(y_bm, resolution = 0.5)
DimPlot(y_bm, reduction = "umap", group.by = "RNA_snn_res.0.5", label = TRUE, repel = TRUE)

```


# plot cell frequency
```{r}

bm@meta.data %>%
  group_by(sample, sex) %>%
  count(sctypeqin) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = sex, y = pct, color = sctypeqin)) + #+ geom_bar(stat='identity') + theme(axis.text.x = element_text(angle=45, hjust=1))
  geom_point() +
  geom_boxplot() +
  facet_wrap(~sctypeqin, scales = "free") +
  labs(title = "Distribution per cell type")
# make same violin plot
bm@meta.data %>%
  group_by(sample, sex, age) %>%
  count(sctypeqin) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = sex, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~sctypeqin, scales = "free") +
  labs(title = "Distribution per cell type")
# same code changing sctypeqin for sctypeclassif
bm@meta.data %>%
  group_by(sample, sex) %>%
  count(sctypeclassif) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = sex, y = pct, color = sctypeclassif)) +
  geom_point() +
  facet_wrap(~sctypeclassif, scales = "free") +
  labs(title = "Distribution per cell type")
# only under 45
bm@meta.data %>%
  filter(age <= 45) %>%
  group_by(sample, sex, age) %>%
  count(sctypeqin) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = sex, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  # add text with age to each point
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~sctypeqin, scales = "free") +
  labs(title = "Distribution per cell type")
# above 45
bm@meta.data %>%
  filter(age > 45) %>%
  group_by(sample, sex, age) %>%
  count(sctypeqin) %>%
  mutate(pct = n / sum(n)) %>%
  ggplot(aes(x = sex, y = pct, color = age)) +
  geom_violin() +
  geom_point() +
  # add text with age to each point
  geom_text(aes(label = age), size = 3, vjust = -0.5) +
  facet_wrap(~sctypeqin, scales = "free") +
  labs(title = "Distribution per cell type")
```


# add annotation from DISCO
It is better to add the annotation because I know I have raw counts and not normalized counts.
First we load DISCO
```{r load disco}
disco_bm_v2 <- readRDS("data/DISCO/bmv2_fixed.rds")
```
Then we add the annotation to the object
```{r add annotation from DISCO}
# extract ct and simplified_ct columns
disco_bm_v2@meta.data %>%
        filter(project_id == "GSE120221") %>%
  select(ct, simplified_ct) %>%
        mutate(cell_id = rownames(.)) %>%
        separate(cell_id, into = c("cell_id", "sample"), sep = "--")  %>%
        mutate(cell_id = paste0(sample, "_",cell_id)) -> disco_bm_v2_ct_df

bm@meta.data %>%
  select(orig.ident) %>%
          mutate(cell_id = rownames(.)) %>%
  separate(orig.ident, into = c("sample", "sample_name"), sep = "_") %>%
            separate(cell_id, into = c("sample_name", "cell_id"), sep = "_") %>%
  mutate(cell_id = paste0(sample, "_",cell_id)) -> cell_id_sample_df

cell_id_sample_df %>%
  left_join(disco_bm_v2_ct_df, by = "cell_id") -> full_annotation_df
# try with coalesce, or change QC values
# add new cell_id
# FIX NON-UNIQUE CELL IDS


rownames(disco_bm_v2_ct_df) <- disco_bm_v2_ct_df$cell_id
# add metadata to oejten
bm <- AddMetaData(object = bm, metadata = disco_bm_v2_ct_df$ct, col.name = "ct")
bm <- AddMetaData(object = bm, metadata = disco_bm_v2_ct_df$simplified_ct, col.name = "simplified_ct")
```