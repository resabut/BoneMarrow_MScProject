---
title: "Create HCA object - Bone Marrow"
output: html_notebook
---

# Loading

```{r}
rm(list=ls())
```


## Load libraries

```{r load_libraries}
library(CuratedAtlasQueryR)
library(dplyr)
library(ggplot2)
```

## Load metadata
Loads the whole database metadata

```{r load_metadata}
metadata <- get_metadata()
metadata
```

# Explore metadata
## All columns

```{r explore_metadata}
metadata %>%
  glimpse()
```
## Select just bone marrow

It is in the "bone marrow" in the tissue column. The tissue_harmonised column is a more general one that can be used.

```{r explore_metadata_bone_marrow}
# bm dataset list
metadata %>%
  distinct(file_id, tissue, name) %>%
  filter(tissue == "bone marrow")
# number of datasets
metadata %>%
  distinct(file_id, tissue, name) %>%
  filter(tissue == "bone marrow") %>%
  count()

# only bone marrow metadata
bm_metadata <- metadata %>%
  filter(tissue == "bone marrow")
```
We have 12 datasets.
Looking at the list we can already see that some of the mare not for the full bone marrow, but only for a part of it.

## Overview per dataset

```{r explore_metadata_bone_marrow_overview}
# for ever dataset_id, get cell_counts, and sex
bm_metadata %>%
        count(name, sex, sample_, disease) %>%
        group_by(sex, name, disease) %>%
        summarise(sex_counts = n())
```


## Pick one
Let's pick the "Global" dataset because it has a good amount of data.


```{r explore_metadata_bone_marrow_overview_global}
bm_metadata %>%
    filter(name == "Global") -> bm_metadata_global

```
### Some metadata about it

```{r}
# cell counts per cell type
bm_metadata_global %>%
    group_by(cell_type) %>%
    summarise(cell_counts = n())
# cell coutns per cell_type_harmonised
bm_metadata_global %>%
    group_by(cell_type_harmonised, cell_type) %>%
    summarise(cell_counts = n())
# print all cell_types in a list
bm_metadata_global %>%
    distinct(cell_type)
```

It is clear that the cell_type column makes more sense. Some of the annotations do not match up.



```{r}
effector_T_cells <- c("effector memory CD8-positive, alpha-beta T cell, terminally differentiated", "effector memory CD4-positive, alpha-beta T cell")

memory_T_cells <- c("effector memory CD8-positive, alpha-beta T cell, terminally differentiated", "CD8-positive, alpha-beta memory T cell, CD45RO-positive", "effector memory CD4-positive, alpha-beta T cell", "CD8-positive, alpha-beta memory T cell")

monocytes <- c("classical monocyte", "non-classical monocyte")

natural_killer_cells <- c("CD16-positive, CD56-dim natural killer cell, human", "CD16-negative, CD56-bright natural killer cell, human")

erythrocyte_lineage <- c("erythroid lineage cell")

B_cells <- c("pro-B cell", "precursor B cell", "naive B cell", "memory B cell", "germinal center B cell", "plasmablast", "plasma cell")

T_cells <- c("naive thymus-derived CD4-positive, alpha-beta T cell", "naive thymus-derived CD8-positive, alpha-beta T cell", "gamma-delta T cell", "mucosal invariant T cell", "T follicular helper cell", "T helper", "T regs")

dendritic_cells <- c("conventional dendritic cell", "plasmacytoid dendritic cell")

megakaryocytes <- c("megakaryocyte")

other <- c("animal cell", "macrophage", "mast cell", "alveolar macrophage", "lymphocyte", "group 3 innate lymphoid cell", "alpha-beta T cell")

# create a new column with these annotations
bm_metadata_global %>%
    mutate(cell_type_harmonised = case_when(
        cell_type %in% effector_T_cells ~ "effector T cells",
        cell_type %in% memory_T_cells ~ "memory T cells",
        cell_type %in% monocytes ~ "monocytes",
        cell_type %in% natural_killer_cells ~ "natural killer cells",
        cell_type %in% erythrocyte_lineage ~ "erythrocyte lineage",
        cell_type %in% B_cells ~ "B cells",
        cell_type %in% T_cells ~ "T cells",
        cell_type %in% dendritic_cells ~ "dendritic cells",
        cell_type %in% megakaryocytes ~ "megakaryocytes",
        cell_type %in% other ~ "other",
        TRUE ~ "other"
    )) -> bm_metadata_global
```

### plot cell counts per cell type

```{r}
bm_metadata_global %>%
    group_by(cell_type_harmonised) %>%
    summarise(cell_counts = n()) %>%
    ggplot(aes(x = cell_type_harmonised, y = cell_counts)) +
    geom_col() +
    coord_flip()
# make a pie chart
bm_metadata_global %>%
    group_by(cell_type_harmonised) %>%
    summarise(cell_counts = n()) %>%
    ggplot(aes(x = "", y = cell_counts, fill = cell_type_harmonised)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    theme_void()
# pie chart with cell_type
bm_metadata_global %>%
    group_by(cell_type) %>%
    summarise(cell_counts = n()) %>%
    ggplot(aes(x = "", y = cell_counts, fill = cell_type)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    theme_void()
# plot by sex
bm_metadata_global %>%
  group_by(sample_, sex) %>%
  count(cell_type_harmonised, na.rm=TRUE) %>%
  mutate(pct = n/sum(n) ) %>%
  ggplot(aes(x = sex, y = pct, color = cell_type_harmonised)) +
  geom_point() +
  facet_wrap(~cell_type_harmonised, scales = "free") +
  labs(title = "Distribution per cell type")
```

