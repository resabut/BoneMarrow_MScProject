---
title: "Trajectory analysis"
output:
  html_notebook:
    output_file: "Lamian_Trajectory_analysis_full_DISCO.html"
---


#  Lamian
tutorial from github
https://winnie09.github.io/Wenpin_Hou/pages/Lamian.html
# Load

load the libraries

```{r}
library(slingshot)
library(ggplot2)
library(Seurat)
library(SingleCellExperiment)
library(scales)
library(tradeSeq)
library(RColorBrewer)
library(Lamian)
library(topGO)
library(dplyr)
set.seed(1234)
'%!in%' <- Negate(`%in%`)
# set color palette
pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
# and functions
# from https://bustools.github.io/BUS_notebooks_R/slingshot.html#introduction
#' Assign a color to each cell based on some value
#'
#' @param cell_vars Vector indicating the value of a variable associated with cells.
#' @param pal_fun Palette function that returns a vector of hex colors, whose
#' argument is the length of such a vector.
#' @param ... Extra arguments for pal_fun.
#' @return A vector of hex colors with one entry for each cell.
cell_pal <- function(cell_vars, pal_fun,...) {
  if (is.numeric(cell_vars)) {
    pal <- pal_fun(100, ...)
    return(pal[cut(cell_vars, breaks = 100)])
  } else {
    categories <- sort(unique(cell_vars))
    pal <- setNames(pal_fun(length(categories), ...), categories)
    return(pal[cell_vars])
  }
}

```

load data
```{r}
setwd("/home/inf-38-2022/MScProject/03_TrajectoryAnalysis/")
data <- readRDS("../01_Integration/data/DISCO/full_DISCO_sex_annotated.rds")
```

```{r}
data <- FindVariableFeatures(data)
data <- ScaleData(data, verbose = FALSE)
data <- RunPCA(data, verbose = FALSE)
```
```{r}
# data <- subset(data, subset = ct != "HSC" )
# # run umap
# data <- RunUMAP(data, dims = 1:20)
# data <- RunPCA(data, data)
rna.data <- data
rna.data <-  subset(rna.data, subset = ct %in% c("GMP", "S100A+ preNeutrophil", "Metamyelocyte/Band neutrophil",
                 "Neutrophil", "Promyelocyte", "Myelocyte"))
rna.data <- subset(rna.data, subset = project_id %in% c("GSE120221", "HCA_HematopoieticImmuneCellAtlas", "GSE185381"))
# remove cell types with less than 10 cells in one dataset
# this code doesn't account for when a ct hasn't been detected in a dataset
rna.data@meta.data %>% group_by(project_id, ct) %>% summarise(n=n()) %>% filter(n < 10) %>% pull(ct) -> cts_to_remove
rna.data <- subset(rna.data, subset = ct %!in% cts_to_remove)
cell_colors <- cell_pal(rna.data$ct, brewer_pal("qual", "Set2"))
cell_colors_clust <- cell_pal(rna.data$ct, hue_pal())
Idents(rna.data) <- rna.data$ct

```
```{r}
data <- rna.data
# prepare the data
cnt <- data@assays$RNA@counts
pca <- Embeddings(data, "pca")
umap <- Embeddings(data, "umap")
sce <- SingleCellExperiment(assays = list(counts = cnt), colData = colData(as.SingleCellExperiment(data)))
reducedDims(sce) <- list(PCA = pca, UMAP = umap)
# cluster will be "ct"
system.time({
  sce <- slingshot(sce, clusterLabels = 'ct', reducedDim = 'UMAP')
})
```

plot

```{r}
plot(reducedDims(sce)$UMAP,
   col = cell_colors_clust,
  pch=16,
      asp = 1,
 xlab = 'UMAP 1',
ylab = 'UMAP 2')
lines(SlingshotDataSet(sce), lwd=2, type = 'lineages', col = 'black')
lines(SlingshotDataSet(sce)@curves$Lineage1$s, lwd=2, col = 'red')

# pseudotime
library(grDevices)
colors <- colorRampPalette(brewer.pal(11,'Spectral')[-6])(nrow(umap))
plotcol <- colors[cut(sce$slingPseudotime_1, breaks=nrow(umap))]
plot(reducedDims(sce)$UMAP,
     col = plotcol,
     pch=16,
     asp = 1,
     xlab = 'UMAP 1',
     ylab = 'UMAP 2')
lines(SlingshotDataSet(sce)@curves$Lineage1$s, lwd=2, col='black')
```



```{r}
# select one lineages
pt <- sce$slingPseudotime_1
# pt <- round(pt*10000) # made them integers
names(pt) <- colnames(cnt) # add name of cells
summary(pt)
```

It is good if not NA's
Otherwise, remove them

```{r}
pt <- pt[!is.na(pt)]
selectedCell <- names(pt)
```


check cells per sample
```{r}
data@meta.data %>%
        filter(rownames(.) %in% selectedCell) %>%
        count(sample)
```
Some cells have very few cells, less than 50
let's remove them
```{r}
sample <- data@meta.data %>%
        filter(rownames(.) %in% selectedCell) %>%
          dplyr::select(sample)
selectedSample <- data@meta.data %>%
        filter(rownames(.) %in% selectedCell) %>%
        count(sample) %>%
          filter(n > 50) %>%
            pull(sample)
selectedCell2 <-data@meta.data %>%
        filter(rownames(.) %in% selectedCell) %>%
        filter(sample %in% selectedSample) %>%
            rownames()
# subset sce
sce <- sce[,selectedCell2]
data_sub <- subset(data, cells = selectedCell2)
data_sub@meta.data %>%
        filter(rownames(.) %in% selectedCell) %>%
        count(sample)
```




Run module 3
```{r}
select <- dplyr::select
cellanno <- data_sub@meta.data %>%
        dplyr::select(ct, sample) %>%
        mutate(cell = as.character(rownames(.)),
               sample = as.character(sample)) %>%
        dplyr::select(cell, sample)

sex_design <- data_sub@meta.data %>%
        distinct(Predicted_sex, sample) %>%
        mutate(intercept = 1) %>%
        mutate(sex_bin = ifelse(Predicted_sex == "M", 1,
                                ifelse(Predicted_sex == "F", 0, NA)))
rownames(sex_design) <- sex_design$sample
sex_design %>% select(intercept, sex_bin) -> sex_design

# sex and project design
sex_proj_design <- data_sub@meta.data %>%
        distinct(Predicted_sex, sample, project_id) %>%
                mutate(intercept = 1) %>%
                mutate(sex_bin = ifelse(Predicted_sex == "M", 1,
                                ifelse(Predicted_sex == "F", 0, NA)))
rownames(sex_proj_design) <- sex_proj_design$sample
sex_proj_design %>% select(intercept, sex_bin, project_id) -> sex_proj_design


# only variable features
data_sub <- FindVariableFeatures(data_sub, selection.method = "vst", nfeatures = 5000)
var_genes <- VariableFeatures(data_sub)
GetAssayData(data_sub)[var_genes,]-> expr
filtr_expr <- expr
# filtr_expr <- expr[rowSums(expr > 10) > ncol(expr)/100, ]
filtr_expr <- LogNormalize(filtr_expr)

Res <- lamian_test(
expr = as.matrix(filtr_expr),
cellanno = cellanno,
pseudotime = pt[selectedCell2],
design = sex_proj_design,
verbose.output = TRUE,
test.type = 'variable',
testvar = 2,
permuiter = 4,
ncores = 10
)
```


## downstream anylsis
```{r}
stat <- Res$statistics
stat <- stat[order(stat[, 1], -stat[, 3]),]
# genes with FDR.overall < 0.05 cutoff
diffgene <- rownames(stat[stat[, grep ('^fdr.*overall$', colnames(stat))]< 0.05, ])
length(diffgene)
```



Estimate at the population level
```{r}
Res$populationFit <- getPopulationFit(Res, gene = diffgene, type = 'variable')
```
Group difference for a given covariate
```{r}
Res$covariateGroupDiff <- getCovariateGroupDiff(testobj = Res, gene = diffgene)
Res$cluster <- clusterGene(Res, gene = diffgene, type = 'variable', k = 5) # change k because if very few genes
```
I had only 4 genes when testing with 5 clusters, so I changed it to k=2

save rds
```{r}
saveRDS(Res, file = 'Res_5_sex_neutro.rds')
```



plot expression values
there is an issue with the colours
source("mod_plotXDEHm.R")
environment(mod_plotXDEHm) <- asNamespace('Lamian')
assignInNamespace("plotXDEHm", mod_plotXDEHm, ns='Lamian')

this is a hack to get around the issue
```{r}
source("mod_plotXDEHm.R")
environment(mod_plotXDEHm) <- asNamespace('Lamian')
assignInNamespace("plotXDEHm", mod_plotXDEHm, ns='Lamian')
mod_plotXDEHm(
  Res,
  cellWidthTotal = 180,
  cellHeightTotal = 350,
  subsampleCell = FALSE,
  sep = ':.*'
)
```

Cluster mean and difference

Another issue
source("mod_plotClusterMeanAndDiff.R")
environment(mod_plotClusterMeanAndDiff) <- asNamespace('Lamian')
assignInNamespace("plotClusterMeanAndDiff", mod_plotClusterMeanAndDiff, ns='Lamian')
```{r}
source("mod_plotClusterMeanAndDiff.R")
environment(mod_plotClusterMeanAndDiff) <- asNamespace('Lamian')
assignInNamespace("plotClusterMeanAndDiff", mod_plotClusterMeanAndDiff, ns='Lamian')
mod_plotClusterMeanAndDiff(Res) # mean doesn't work
# just diff
plotClusterDiff(Res, gene = diffgene)
```

It seems like only cluster 8 is consistently differentially expressed

```{r}
# plot Gene
plotGene(Res, gene = diffgene[1], variable="sex_bin")
```





## GO analysis
```{r}
library(topGO)
goRes <- GOEnrich(testobj = Res, type = 'variable')
# save list of tables to excel
openxlsx::write.xlsx(goRes, file = 'goRes.xlsx')
```

```{r}
plotGOEnrich(goRes)
```

If error Error in dim(ordered) <- ns (03_Trajectoryanalysis.rmd#591): dims [product 1] do not match the length of object [0]
it is because there is nothing to show, nothing passes the significant threshold
