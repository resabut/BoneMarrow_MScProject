---
title: "Trajectory Analysis with HCA"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.height = 9, fig.width = 7, fig.crop = FALSE)
```

# Load
## Load libraries
```{r load-libraries, message=FALSE, warning=FALSE}
library(monocle3)
library(Seurat)
library(SeuratWrappers)
library(patchwork)
library(ggplot2)
set.seed(1234)
```
## Functions

```{r functions}
# From the tutorial cole-trapnell-lab.github.io/monocle3/docs/trajectories/
# a helper function to identify the root principal points:
get_earliest_principal_node <- function(monocle3_object) {
  closest_vertex <- monocle3_object@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
  closest_vertex <- as.matrix(closest_vertex[colnames(monocle3_object), ])
  root_pr_nodes <- igraph::V(principal_graph(monocle3_object)[["UMAP"]])$name[as.numeric(names(which.max(table(closest_vertex))))]

  root_pr_nodes
}
```

## load data

```{r load data}
# load data
data <- readRDS("data/HCA/HCA_HematopoieticImmuneCellAtlas.rds")
```
## Initialise variables
```{r initialise variables}
# list of plots
plots <- list()
```

# Seurat to Monocle3

```{r seurat to monocle3}
# convert to monocle3 object
cds <- as.cell_data_set(data)
```

# Clustering
Monocle 3 requires its own type of clustering
```{r clustering}
cds <- cluster_cells(cds, resolution = 1e-5)
print("Clustering done")
```

We can plot the clusters
```{r plot clusters}
cluster_plot <- plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE)
cluster_plot
# plot partitions
partition_plot <- plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE)
partition_plot

# add plots to list
plots <- c(plots, list(cluster_plot, partition_plot))
```

# Pseudo-time trajectory
## Learn graph
First it needs to learn the graph
```{r learn graph}
cds <- learn_graph(cds, use_partition = TRUE, verbose = FALSE)
print("Graph learned")
```

We can plot them
```{r plot graph}
plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = TRUE)
# plot with cell type
trajectory_ct_plot <- plot_cells(cds, color_cells_by = "ct", group_label_size = 4,
                                 labels_per_group = 5, #they are grouped bycluster.
                                            label_principal_points = TRUE,
                                 label_groups_by_cluster = FALSE,
                                            show_trajectory_graph = TRUE)
trajectory_ct_plot
trajectory_simplified_ct_plot <- plot_cells(cds, color_cells_by = "simplified_ct",
                                            group_label_size = 1,
                                            label_principal_points = TRUE,
                                            show_trajectory_graph = TRUE)
trajectory_simplified_ct_plot
# add to plot list
plots <- c(plots, list(trajectory_ct_plot, trajectory_simplified_ct_plot))
```

I do not save the plot because we will plot it better later.

## Order cells

We can order them automatically

```{r order cells atomatically}
# order automatically
cds <- order_cells(cds, root_pr_nodes = get_earliest_principal_node(cds))
print("Cells ordered")

# plot cells by pseudotime
autom_order_TA_plot <- plot_cells(cds, color_cells_by = "pseudotime", show_trajectory_graph = TRUE)
autom_order_TA_plot

# add to plot list
plots <- c(plots, list(autom_order_TA_plot))
```

Or manually choose a node.
In this case, we know that the HSC are at the center, and from a previous plot;
they can be rooted at Y_287

```{r order cells manually}
# order manually
cds <- order_cells(cds, root_pr_nodes = "Y_287")
print("Cells ordered")

# plot
# plot cells by pseudotime
progenitor_root_TA_plot <- plot_cells(cds, color_cells_by = "pseudotime", show_trajectory_graph = TRUE)
progenitor_root_TA_plot

# add to plot list
plots <- c(plots, list(progenitor_root_TA_plot))
```


# Branch analysis
We can pick one branch and analyse it.
Let's do the one from Y_287 to Y_305 (monocytes with CD14+ low MHCII)
```{r branch analysis}
# pick a branch
cd14_traj <- choose_graph_segments(cds,
starting_pr_node = "Y_170",
ending_pr_nodes = "Y_305")

# interactive pick
# cd14_traj <- choose_graph_segments(cds)
```

It doesn't work, Disconnected graph

We can plot it
```{r}
cd14_plot <- plot_cells(cd14_traj, color_cells_by = "partition", show_trajectory_graph = TRUE)
cd14_plot
```

# Save
## save plots
```{r save plots}
# save plots
pdf("formatted/HCA/HCA_HematopoieticImmuneCellAtlas_trajectory_analysis.pdf",width = 11, height = 9)
plots
dev.off()
```
## save cds
```{r save cds}
# save cds
saveRDS(cds, "data/HCA/HCA_HematopoieticImmuneCellAtlas_monocle3.rds", compress = FALSE)
```

To load it again
```{r load cds}
# load cds
cds <- readRDS("data/HCA/HCA_HematopoieticImmuneCellAtlas_monocle3.rds")
```
